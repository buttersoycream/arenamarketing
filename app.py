import streamlit as st
import google.generativeai as genai
import datetime

# ==========================================
# 1. API í‚¤ ì„¤ì • (Streamlit Cloud ë°°í¬ìš©)
# ==========================================
# ë°°í¬í•  ë•ŒëŠ” ì•„ë˜ì²˜ëŸ¼ st.secretsë¥¼ ì¨ì•¼ ì•ˆì „í•©ë‹ˆë‹¤.
# ë¡œì»¬ì—ì„œ í…ŒìŠ¤íŠ¸í•  ë•ŒëŠ” secrets.toml íŒŒì¼ì„ ë§Œë“¤ê±°ë‚˜, 
# ì„ì‹œë¡œ API_KEY = "ë‚´_í‚¤_ì§ì ‘_ì…ë ¥" í•´ë„ ë©ë‹ˆë‹¤.
try:
    API_KEY = st.secrets["GOOGLE_API_KEY"]
except:
    # ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš© (ì—¬ê¸°ì— í‚¤ë¥¼ ë„£ê³  í…ŒìŠ¤íŠ¸í•˜ë‹¤ê°€ ë°°í¬ ì „ì—” ì§€ìš°ê±°ë‚˜ ì£¼ì„ì²˜ë¦¬ í•˜ì„¸ìš”)
    API_KEY = "AIzaSyC4HnIp1H3_WwepLyB907s6XuAh3dSK0ME" 

genai.configure(api_key=API_KEY)
MODEL_NAME = 'gemini-3-pro-preview' # 3.0 ëª¨ë¸ ì‚¬ìš©

# ==========================================
# 2. ë§ˆì¼€íŒ… ì œì•ˆ ìƒì„± í•¨ìˆ˜
# ==========================================
def get_marketing_suggestion():
    today = datetime.datetime.now()
    date_str = today.strftime("%Yë…„ %mì›” %dì¼")
    weekday = today.strftime("%A") 
    days = {'Monday':'ì›”', 'Tuesday':'í™”', 'Wednesday':'ìˆ˜', 'Thursday':'ëª©', 'Friday':'ê¸ˆ', 'Saturday':'í† ', 'Sunday':'ì¼'}
    weekday_kr = days.get(weekday, weekday)

    model = genai.GenerativeModel(MODEL_NAME)
    
    prompt = f"""
    ë‹¹ì‹ ì€ ì•„ë ˆë‚˜ ìˆ˜ì˜ë³µ ë§¤ì¥ì˜ ìœ ëŠ¥í•œ ë§ˆì¼€íŒ… íŒ€ì¥ì…ë‹ˆë‹¤.
    ì˜¤ëŠ˜ ë‚ ì§œ({date_str}, {weekday_kr}ìš”ì¼)ì™€ í˜„ì¬ ì‹œì¦Œì„ ê³ ë ¤í•´ì„œ ë§ˆì¼€íŒ… ì•„ì´ë””ì–´ 3ê°€ì§€ë¥¼ ì œì•ˆí•´ì£¼ì„¸ìš”.
    
    [ë§¤ì¥ ìƒí™©]
    - ìœ„ì¹˜: êµ¬ë¡œì—­ NCë°±í™”ì  ì•„ë ˆë‚˜
    - ì´ìŠˆ: ì£¼ë³€ ì‹¤ë‚´ ìˆ˜ì˜ì¥ ë¦¬ëª¨ë¸ë§ ì˜¤í”ˆ

    [âš ï¸ ì¤‘ìš”: ê°€ê²© ì •ì±…]
    - ë§¤ë‹ˆì € ì¬ëŸ‰ìœ¼ë¡œ í• ì¸ì„ í•´ì¤„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í• ì¸ ì œì•ˆì€ í•˜ì§€ ë§ˆì„¸ìš”.
    - ëŒ€ì‹  'ì‹ ìƒ ì…ê³ ', 'ì‚¬ì´ì¦ˆ ìƒë‹´', 'ì‚¬ì€í’ˆ ì¦ì •(ìˆ˜ëª¨ ë“±)' ê°™ì€ ì„œë¹„ìŠ¤ì ì¸ ì¸¡ë©´ì„ ê°•ì¡°í•˜ëŠ” ì „ëµì„ ì§œì£¼ì„¸ìš”.
    """
    
    return model.generate_content(prompt).text

# ==========================================
# 3. í™ë³´ê¸€ ì‘ì„± ëª¨ë¸ ì„¤ì • (ì—¬ê¸°ê°€ í•µì‹¬!)
# ==========================================
system_instruction = """
ë‹¹ì‹ ì€ ì•„ë ˆë‚˜ NCêµ¬ë¡œì ì˜ ì˜¨ë¼ì¸ ë§ˆì¼€íŒ… ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì‚¬ìš©ìê°€ ì…ë ¥í•œ ìƒí’ˆ íŠ¹ì§•ê³¼ ìƒí™©ì„ ë°”íƒ•ìœ¼ë¡œ SNS í™ë³´ê¸€ì„ ì‘ì„±í•©ë‹ˆë‹¤.

[âš ï¸ ì ˆëŒ€ ê¸ˆì§€ ì‚¬í•­ (Strict Rules)]
1. **ì„ì˜ í• ì¸ ì–¸ê¸‰ ê¸ˆì§€:** ë‹¹ì‹ ì€ ì¤‘ê°„ ê´€ë¦¬ìì´ë¯€ë¡œ ë§ˆìŒëŒ€ë¡œ ê°€ê²©ì„ ê¹ì•„ì¤„ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.
2. **ì„¸íŠ¸ í• ì¸ ê¸ˆì§€:** "ì„¸íŠ¸ë¡œ ì‚¬ì‹œë©´ ì‹¸ê²Œ ë“œë ¤ìš”", "2ê°œ ì‚¬ë©´ 10% í• ì¸" ê°™ì€ ë©˜íŠ¸ëŠ” ì ˆëŒ€ ì“°ì§€ ë§ˆì„¸ìš”.
3. **ì˜¤ì§ íŒ©íŠ¸ë§Œ:** ì‚¬ìš©ìê°€ ì…ë ¥ì°½ì— "ì´ ì œí’ˆ 20% ì„¸ì¼ ì¤‘"ì´ë¼ê³  ëª…ì‹œí–ˆì„ ë•Œë§Œ í• ì¸ì„ ì–¸ê¸‰í•˜ì„¸ìš”. ê·¸ ì™¸ì—ëŠ” ì •ê°€ íŒë§¤ê°€ ì›ì¹™ì…ë‹ˆë‹¤.
4. í• ì¸ ëŒ€ì‹  ê°•ì¡°í•  ê²ƒ: "ì „ë¬¸ì ì¸ í•íŒ… ì„œë¹„ìŠ¤", "ì‚¬ì€í’ˆ ì±™ê²¨ë“œë¦¼", "ì¹œì ˆí•œ ìƒë‹´" ë“± ì„œë¹„ìŠ¤ë‚˜ í’ˆì§ˆì„ ê°•ì¡°í•˜ì„¸ìš”.

[ë§íˆ¬ ê°€ì´ë“œ]
- ì¸ìŠ¤íƒ€ê·¸ë¨: íŠ¸ë Œë””í•˜ê³  ì§§ê²Œ, ì´ëª¨í‹°ì½˜ í•„ìˆ˜
- ë¸”ë¡œê·¸: ì •ë³´ì„± ìˆê²Œ ê¼¼ê¼¼í•˜ê²Œ
- ë‹¹ê·¼ë§ˆì¼“: ì •ê²¹ê³  ì˜ˆì˜ ë°”ë¥´ê²Œ
"""

# ==========================================
# 4. í™”ë©´ ë””ìì¸
# ==========================================
st.set_page_config(page_title="ì•„ë ˆë‚˜ AI ë§ˆì¼€í„° (v3.1)", page_icon="ğŸŠâ€â™€ï¸", layout="wide")

st.title(f"ğŸŠâ€â™€ï¸ ì•„ë ˆë‚˜ AI ë§ˆì¼€í„°")
st.caption("í• ì¸ ì •ì±…ì´ ë°˜ì˜ëœ ì•ˆì „í•œ ë§ˆì¼€íŒ… ë¹„ì„œì…ë‹ˆë‹¤.")

st.divider()

# --- [ì„¹ì…˜ 1: ì˜¤ëŠ˜ì˜ ì „ëµ] ---
if 'suggestion' not in st.session_state:
    st.session_state['suggestion'] = None

if st.button("ğŸ’¡ ì˜¤ëŠ˜ì˜ ë§ˆì¼€íŒ… ì•„ì´ë””ì–´ ë°›ê¸°"):
    with st.spinner("íŠ¸ë Œë“œ ë¶„ì„ ì¤‘..."):
        try:
            st.session_state['suggestion'] = get_marketing_suggestion()
        except Exception as e:
            st.error(f"ì—ëŸ¬ ë°œìƒ: {e}")

if st.session_state['suggestion']:
    st.info(st.session_state['suggestion'])

st.divider()

# --- [ì„¹ì…˜ 2: í™ë³´ê¸€ ì‘ì„±] ---
st.subheader("âœï¸ í™ë³´ê¸€ ì‘ì„±í•˜ê¸°")

col1, col2 = st.columns(2)
with col1:
    target = st.selectbox("íƒ€ê²Ÿ ê³ ê°", ["ìˆ˜ì˜ ì´ˆë³´/ê°•ìŠµìƒ", "ìˆ˜ì˜ ê³ ìˆ˜/ë§¤ë‹ˆì•„", "í˜¸ìº‰ìŠ¤/ì—¬í–‰ê°", "ì„ ë¬¼ìš© êµ¬ë§¤"])
with col2:
    platform = st.selectbox("ì—…ë¡œë“œ í”Œë«í¼", ["ì¸ìŠ¤íƒ€ê·¸ë¨", "ë„¤ì´ë²„ ë¸”ë¡œê·¸", "ë‹¹ê·¼ë§ˆì¼“"])

product_info = st.text_area(
    "ìƒí’ˆ íŠ¹ì§• ë° ì •ë³´",
    height=100,
    placeholder="ì˜ˆ: ì‹ ìƒ íƒ„íƒ„ì´, í™”ë ¤í•œ íŒ¨í„´. (í• ì¸ ì¤‘ì´ë¼ë©´ '20% í• ì¸ ì¤‘'ì´ë¼ê³  ê¼­ ì ì–´ì£¼ì„¸ìš”!)"
)

if st.button("âœ¨ í™ë³´ê¸€ ìƒì„±í•˜ê¸°", type="primary"):
    if not product_info:
        st.warning("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!")
    else:
        with st.spinner("ê°€ê²© ì •ì±… ì¤€ìˆ˜í•˜ë©° ê¸€ ì“°ëŠ” ì¤‘..."):
            try:
                # ì‹œìŠ¤í…œ ì§€ì‹œì‚¬í•­ì´ í¬í•¨ëœ ëª¨ë¸ ë¡œë“œ
                writer_model = genai.GenerativeModel(MODEL_NAME, system_instruction=system_instruction)
                
                prompt = f"""
                ìƒí’ˆ ë° ìƒí™©: {product_info}
                íƒ€ê²Ÿ: {target}
                í”Œë«í¼: {platform}
                
                ìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í™ë³´ê¸€ì„ ì‘ì„±í•´ì£¼ì„¸ìš”. (ê¸ˆì§€ëœ í• ì¸ ë©˜íŠ¸ ì ˆëŒ€ ì‚¬ìš© ë¶ˆê°€)
                """
                response = writer_model.generate_content(prompt)
                st.success("ì‘ì„± ì™„ë£Œ!")
                st.markdown(response.text)
            except Exception as e:
                st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")
